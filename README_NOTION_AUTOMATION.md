# Notionステータス自動更新システム

Notionデータベースのステータスを自動的に更新するシステム

## 📋 概要

`notion_status_automation.py` は、Notionデータベースを監視して、以下の処理を自動実行します：

### 1. ステータスの自動更新

**Status(コンテンツ作成)が「完了」の場合**:
- ✅ **Status(Web)** → 「投稿待ち」に自動変更
- ✅ **Status(Podcast)** → 「音声化待ち」に自動変更

### 2. 日付の自動記録

以下の条件で日付を自動記録（日付が空欄の場合のみ）:
- **Date(Select)**: Status(コンテンツ作成)が「執筆待ち(URL)」or「執筆待ち(PDF)」の場合
- **Date(W-complete)**: Status(Web)が「スケジュール待ち」の場合
- **Date(P-complete)**: Status(Podcast)が「完了」の場合

## 🎯 動作イメージ

```
【例】記事のライフサイクル

1. Notionに情報源URLを登録
   └─ Status(コンテンツ作成): デフォルト

2. 手動でステータス変更
   └─ Status(コンテンツ作成): デフォルト → 執筆待ち(PDF)
   └─ ⚡ Date(Select)が自動記録される

3. Pythonスクリプトが記事を生成
   └─ Status(コンテンツ作成): 執筆待ち(PDF) → ファクトチェック待ち

4. 手動でファクトチェック完了
   └─ Status(コンテンツ作成): ファクトチェック待ち → 完了

5. ⚡ 自動更新スクリプトが実行（1時間以内）
   └─ Status(Web): デフォルト → 投稿待ち
   └─ Status(Podcast): デフォルト → 音声化待ち

6. 手動で投稿準備完了
   └─ Status(Web): 投稿待ち → スケジュール待ち
   └─ ⚡ Date(W-complete)が自動記録される

7. WordPress自動アップロード（別スクリプト）
   └─ Status(Web): スケジュール待ち → 完了
```

## 🚀 使い方

### ローカルで手動実行

```bash
cd health-policy-watcher
.\venv\Scripts\python.exe src\notion_status_automation.py
```

### GitHub Actionsで自動実行（推奨）

1. `.github/workflows/notion_automation.yml` をGitHubにプッシュ
2. GitHub Secretsが設定済みであることを確認（NOTION_API_KEY, NOTION_DATABASE_ID）
3. 完了！1時間ごとに自動実行されます

**実行スケジュール**: 毎時0分（例: 0:00, 1:00, 2:00...）

## 📊 実行結果の例

```
2026-02-15 21:06:08 - INFO - ==================================================
2026-02-15 21:06:08 - INFO - Notionステータス自動更新を開始します
2026-02-15 21:06:08 - INFO - ==================================================
2026-02-15 21:06:08 - INFO - Status(コンテンツ作成)が「完了」のページを検索中...
2026-02-15 21:06:09 - INFO - 2 件のページが見つかりました

2026-02-15 21:06:09 - INFO - 処理中: 第254回社会保障審議会介護給付費分科会...
2026-02-15 21:06:09 - INFO -   現在のStatus(Web): デフォルト
2026-02-15 21:06:09 - INFO -   現在のStatus(Podcast): デフォルト
2026-02-15 21:06:09 - INFO -   → Status(Web)を「投稿待ち」に変更
2026-02-15 21:06:09 - INFO -   → Status(Podcast)を「音声化待ち」に変更
2026-02-15 21:06:10 - INFO -   ✅ 更新成功

2026-02-15 21:06:10 - INFO - 
日付の自動記録処理を開始...
2026-02-15 21:06:10 - INFO - 第254回社会保障審議会... → Date(Select)を記録

2026-02-15 21:06:10 - INFO - ==================================================
2026-02-15 21:06:10 - INFO - 処理完了
2026-02-15 21:06:10 - INFO - ステータス更新: 2 件
2026-02-15 21:06:10 - INFO - 日付記録: 1 件
2026-02-15 21:06:10 - INFO - ==================================================
```

## ⚙️ カスタマイズ

### 実行頻度を変更したい場合

`.github/workflows/notion_automation.yml` の以下の行を編集:

```yaml
schedule:
  - cron: '0 * * * *'  # 毎時0分
```

例：
- `*/30 * * * *` → 30分ごと
- `0 */6 * * *` → 6時間ごと（0:00, 6:00, 12:00, 18:00）
- `0 9,15,21 * * *` → 1日3回（9:00, 15:00, 21:00）

## 🔧 トラブルシューティング

### ステータスが更新されない

**確認事項**:
1. NotionDBに「Status(コンテンツ作成) = 完了」のページが存在するか
2. Status(Web), Status(Podcast)が「デフォルト」状態か
3. Notion API Keyの権限が正しいか

**対策**: 手動実行してログを確認

### 日付が記録されない

**原因**: 既に日付が記録済み、またはステータスが条件に合っていない

**動作**: このスクリプトは「日付が空欄」かつ「ステータスが条件に合致」の場合のみ記録します

### 「401 Unauthorized」エラー

**原因**: Notion API Keyが無効

**対策**: GitHub Secretsの `NOTION_API_KEY` を更新

## 📁 関連ファイル

- `src/notion_status_automation.py`: メインスクリプト
- `.github/workflows/notion_automation.yml`: GitHub Actions ワークフロー
- `notion_automation.log`: 実行ログ（ローカル実行時）

## 🔗 関連システム

このスクリプトは以下のシステムと連携します：

1. **ニュース収集** (`fetch_news_to_notion.py`)
   - 毎日9:00に実行
   - 情報源からNotionに記事URLを自動登録

2. **ステータス自動更新** (`notion_status_automation.py`) ← このスクリプト
   - 毎時0分に実行
   - コンテンツ完成後のステータスを自動更新

3. **WordPress自動投稿** （今後実装）
   - Status(Web) = "スケジュール待ち" を検知
   - WordPressに自動アップロード

## ✅ チェックリスト

スクリプトが正常に動作していることを確認：

- [ ] ローカルで手動実行が成功する
- [ ] GitHub Actionsでの実行が成功する
- [ ] Notionでステータスが正しく更新されている
- [ ] 日付が適切に記録されている
- [ ] `notion_automation.log` にエラーが記録されていない

すべてチェックできたら、自動化システムの完成です！🎉
